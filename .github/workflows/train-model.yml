name: Train Model with MLflow

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 0 * * 0'  # Menjalankan training setiap Minggu tengah malam
  workflow_dispatch:      # Memungkinkan trigger manual dari tab Actions

jobs:
  train:
    runs-on: ubuntu-latest
    
    steps:
    # 1. Setup Job
    - name: Set up job
      run: echo "Memulai job training model MLflow..."
    
    # 2. Checkout kode dari repository
    - name: Checkout repository
      uses: actions/checkout@v4
    
    # 3. Setup Python versi 3.12.7
    - name: Set up Python 3.12.7
      uses: actions/setup-python@v5
      with:
        python-version: '3.12.7'
    
    # 4. Check Environment (Verifikasi)
    - name: Check Environment
      run: |
        python --version
        pip --version
    
    # 5. Install dependencies umum
    - name: Install dependencies
      run: |
        pip install --upgrade pip
        pip install mlflow scikit-learn pandas numpy
    
    # 6. Setup koneksi ke MLflow Tracking Server (menggunakan Secrets GitHub)
    - name: Set up MLflow Tracking URI
      run: |
        echo "MLFLOW_TRACKING_URI=${{ secrets.MLFLOW_TRACKING_URI }}" >> $GITHUB_ENV
        # Hanya tambahkan username/password jika server MLflow memerlukan autentikasi
        echo "MLFLOW_TRACKING_USERNAME=${{ secrets.MLFLOW_TRACKING_USERNAME }}" >> $GITHUB_ENV 2>/dev/null || true
        echo "MLFLOW_TRACKING_PASSWORD=${{ secrets.MLFLOW_TRACKING_PASSWORD }}" >> $GITHUB_ENV 2>/dev/null || true
    
    # 7. [KRITIS] Verifikasi bahwa folder dan file MLProject ada
    - name: Verify MLProject Structure
      run: |
        echo "Verifikasi struktur folder..."
        echo "Isi dari Workflow-CI/:"
        ls -la Workflow-CI/
        echo ""
        echo "Isi dari Workflow-CI/MLProject/:"
        ls -la Workflow-CI/MLProject/
        echo ""
        echo "Memeriksa file wajib:"
        ls -la Workflow-CI/MLProject/conda.yaml
        ls -la Workflow-CI/MLProject/modelling.py
        ls -la Workflow-CI/MLProject/MLProject
        ls -la Workflow-CI/MLProject/water_potability_preprocessing.csv 2>/dev/null || echo "File preprocessing.csv tidak ditemukan. Pastikan file dataset yang sudah dipreprocessing ada."
    
       # GANTI DENGAN INI:
    - name: Install Project Dependencies from conda.yaml
      run: |
        echo "Menginstal dependencies dari conda.yaml..."
        # Install semua packages Python yang ada di conda.yaml menggunakan pip
        cd Workflow-CI/MLProject
        pip install numpy==1.26.4 pandas==2.2.0 scikit-learn==1.5.0 matplotlib==3.8.3 seaborn==0.13.2 mlflow==2.14.2

    - name: Run Modelling Script Directly
      id: run_model
      run: |
        cd Workflow-CI/MLProject
        echo "Menjalankan modelling.py langsung..."
        python modelling.py \
          --data_path "water_potability_preprocessing.csv" \
          --tracking_uri "${{ secrets.MLFLOW_TRACKING_URI }}"
    
    # 9. Ambil run_id dari hasil training terbaru untuk referensi
    - name: Get latest MLflow run_id
      if: success()
      run: |
        cd Workflow-CI/MLProject
        # Mengambil run_id terbaru dari direktori mlruns
        RUN_ID=$(ls -t mlruns/$(ls mlruns/ | head -1)/ | head -1)
        echo "Run ID terbaru: $RUN_ID"
        echo "RUN_ID=$RUN_ID" >> $GITHUB_ENV
    
    # 10. [KRITIS] Upload artifacts hasil training (menggunakan v4, bukan v3)
    - name: Upload MLflow Artifacts
      if: success()
      uses: actions/upload-artifact@v4  # VERSI DIPERBARUI, TIDAK BOLEH v3
      with:
        # Nama artifact unik dengan run_id GitHub untuk menghindari konflik
        name: mlflow-artifacts-${{ github.run_id }}
        # Path ke folder mlruns di DALAM Workflow-CI/MLProject
        path: Workflow-CI/MLProject/mlruns/
        retention-days: 7
    
    # 11. Notifikasi sukses
    - name: Notify Success
      if: success()
      run: |
        echo " Model training berhasil diselesaikan!"
        echo "Run ID MLflow: $RUN_ID"
        echo "Artifact di-upload dengan nama: mlflow-artifacts-${{ github.run_id }}"
    
    # 12. Notifikasi gagal
    - name: Notify Failure
      if: failure()
      run: |
        echo " Model training gagal!"
        echo "Periksa log di atas untuk detail error."
        exit 1
